# ============================================================================
# ST 模型训练配置文件示例
# ============================================================================
# 
# 本文件展示了如何配置 ST 模型的训练数据集划分
# 
# 配置结构：
# 1. [datasets]  - 定义数据集路径
# 2. [training]  - 指定训练集
# 3. [zeroshot]  - 零样本划分（按细胞类型）
# 4. [fewshot]   - 少样本划分（按扰动列表）
#
# 作者: STATE Team
# 更新日期: 2025-12-28
# ============================================================================


# ============================================================================
# 1. 数据集路径配置 [datasets]
# ============================================================================
# 
# 定义数据集名称和文件路径的映射关系
# 
# 格式：
#   数据集名称 = "绝对路径"
#
# 支持的路径格式：
#   - 单个文件："/path/to/data.h5ad"
#   - 通配符（bash 风格）：
#     * "/path/{file1,file2,file3}.h5ad"  - 花括号展开
#     * "/path/*.h5ad"                    - 星号匹配
#
# 注意事项：
#   - 必须使用绝对路径（不支持相对路径）
#   - 路径需要用双引号包围
#   - 数据集名称将在后续配置中引用
# ============================================================================

[datasets]

# 示例 1: 单个数据集文件
# my_dataset = "/data/experiments/my_data.h5ad"

# 示例 2: 使用花括号选择多个文件（推荐）
# Replogle 数据集示例：包含多个细胞系的扰动数据
example = "/data1/fanpeishan/State-Tahoe-Filtered/{c36,c39}.h5ad"

# 示例 3: 使用通配符匹配所有文件
# all_datasets = "/data/experiments/*.h5ad"

# 示例 4: 多个独立数据集
# dataset_A = "/data/dataset_A/processed.h5ad"
# dataset_B = "/data/dataset_B/processed.h5ad"
# dataset_C = "/data/dataset_C/processed.h5ad"


# ============================================================================
# 2. 训练集配置 [training]
# ============================================================================
#
# 指定哪些数据集用于训练
#
# 格式：
#   数据集名称 = "train"
#
# 默认行为：
#   - 被标记为 "train" 的数据集中的所有细胞类型和扰动都会进入训练集
#   - 除非被 [zeroshot] 或 [fewshot] 配置覆盖
#
# 注意事项：
#   - 数据集名称必须在 [datasets] 中已定义
#   - 目前只支持 "train" 值（其他值会被忽略）
# ============================================================================

[training]

# 将 example 数据集用于训练
example = "train"

# 如果有多个数据集，都可以加入训练
# dataset_A = "train"
# dataset_B = "train"


# ============================================================================
# 3. 零样本配置 [zeroshot]
# ============================================================================
#
# 按细胞类型划分验证集和测试集
#
# 格式：
#   "数据集名称.细胞类型名" = "val" 或 "test"
#
# 零样本学习说明：
#   - 将整个细胞类型的所有扰动移到验证集或测试集
#   - 用于测试模型在未见过的细胞类型上的泛化能力
#   - 这是评估跨细胞类型预测能力的关键
#
# 优先级：
#   - zeroshot 配置会覆盖 training 配置
#   - 但会被 fewshot 配置覆盖
#
# 注意事项：
#   - 键名必须用双引号包围（因为包含点号）
#   - 细胞类型名必须与数据中的 cell_type 列完全匹配
#   - 支持的值：
#     * "val"  - 验证集（用于模型选择和超参数调优）
#     * "test" - 测试集（最终评估，不用于调参）
# ============================================================================

[zeroshot]

# 示例：将 example 数据集中的 c39 细胞类型作为测试集
"example.c39" = "test"

# 更多示例：
# "example.c36" = "val"           # c36 作为验证集
# "dataset_A.celltype1" = "val"   # 将 celltype1 作为验证集
# "dataset_A.celltype2" = "test"  # 将 celltype2 作为测试集
# "dataset_B.celltype3" = "test"  # 跨数据集的零样本测试


# ============================================================================
# 4. 少样本配置 [fewshot]
# ============================================================================
#
# 按扰动列表精细划分验证集和测试集
#
# 格式：
#   [fewshot."数据集名称.细胞类型名"]
#   val = ["扰动1", "扰动2", ...]   # 验证集扰动列表（可选）
#   test = ["扰动3", "扰动4", ...]  # 测试集扰动列表（可选）
#
# 少样本学习说明：
#   - 在同一细胞类型内，选择特定扰动作为验证/测试集
#   - 允许更细粒度的数据划分
#   - 用于评估模型对未见过扰动的预测能力
#
# 优先级：
#   - fewshot 配置优先级最高，会覆盖 training 和 zeroshot
#
# 注意事项：
#   - 章节名必须用双引号包围
#   - val 和 test 都是可选的，可以只指定其中一个
#   - 扰动名称必须与数据中的 perturbation 列完全匹配
#   - 列表中的扰动会从训练集中移除
# ============================================================================

[fewshot]

# 基本格式：空配置（不进行少样本划分）
# 如果需要少样本划分，取消注释下面的示例

# 示例 1: 简单的少样本划分
# [fewshot."example.c36"]
# val = ["GENE1", "GENE2", "GENE3"]
# test = ["GENE4", "GENE5", "GENE6"]

# 示例 2: 只划分验证集
# [fewshot."example.c36"]
# val = ["GENE1", "GENE2", "GENE3"]

# 示例 3: 只划分测试集
# [fewshot."example.c39"]
# test = ["GENE7", "GENE8", "GENE9"]

# 示例 4: 完整的 Replogle 数据集划分（hepg2 细胞系）
# [fewshot."replogle.hepg2"]
# val = [
#     # 验证集：约 100 个基因
#     'ATP6V1G1', 'TSEN34', 'TRAPPC8', 'NDUFS3', 'MRPS24', 'DNTTIP2',
#     'WDR77', 'DHX36', 'RTCB', 'RPA3', 'CCDC144NL', 'NFKBIE', 'NFRKB',
#     'TRMT10C', 'DIS3', 'CEP85', 'USP37', 'NPLOC4', 'UCHL5', 'NUP85',
#     # ... 更多基因
# ]
# test = [
#     # 测试集：约 500 个基因
#     'TTF2', 'INO80B', 'ALG14', 'SNRNP27', 'MRPS14', 'UNCX', 'HUWE1',
#     'KAT7', 'DIMT1', 'TCP1', 'DENR', 'NSRP1', 'VPS18', 'SRP19',
#     # ... 更多基因
# ]


# ============================================================================
# 配置验证清单
# ============================================================================
#
# 在开始训练前，请检查：
#
# 1. 数据集路径：
#    □ 所有路径都是绝对路径
#    □ 所有文件都存在且可访问
#    □ 通配符能正确展开
#
# 2. 数据集引用：
#    □ [training] 中引用的数据集都在 [datasets] 中定义
#    □ [zeroshot] 中的细胞类型名称与数据匹配
#    □ [fewshot] 中的扰动名称与数据匹配
#
# 3. 划分策略：
#    □ 每个细胞类型至少有一些样本在训练集中
#    □ 验证集和测试集不为空（如果需要评估）
#    □ 训练集、验证集、测试集没有重叠
#
# 4. TOML 语法：
#    □ 所有键值对格式正确
#    □ 特殊字符的键都用双引号包围
#    □ 列表格式正确（方括号、逗号分隔）
#
# ============================================================================


# ============================================================================
# 使用此配置进行训练的示例命令
# ============================================================================
#
# uv run state tx train \
#     data.kwargs.toml_config_path="path/to/this_config.toml" \
#     data.kwargs.pert_col="gene" \
#     data.kwargs.cell_type_key="cell_type" \
#     data.kwargs.batch_col="batch" \
#     data.kwargs.control_pert="non-targeting" \
#     data.kwargs.output_space="gene" \
#     data.kwargs.num_workers=8 \
#     training.max_steps=40000 \
#     training.batch_size=32 \
#     training.lr=1e-4 \
#     model.kwargs.cell_set_len=128 \
#     model.kwargs.hidden_dim=256 \
#     model=state \
#     output_dir="results" \
#     name="my_experiment"
#
# 注意：
#   - 将 "path/to/this_config.toml" 替换为实际路径
#   - 根据实际数据调整 pert_col、cell_type_key、batch_col
#   - 根据需要调整超参数
#
# ============================================================================


# ============================================================================
# 高级配置示例
# ============================================================================

# 场景 1: 多数据集混合训练，保留一个数据集作为零样本测试
# ----------------------------------------------------------------------------
# [datasets]
# dataset_A = "/data/dataset_A.h5ad"
# dataset_B = "/data/dataset_B.h5ad"
# dataset_C = "/data/dataset_C.h5ad"
#
# [training]
# dataset_A = "train"
# dataset_B = "train"
# dataset_C = "train"
#
# [zeroshot]
# "dataset_C.all_celltypes" = "test"  # 整个数据集 C 作为零样本测试
# ----------------------------------------------------------------------------


# 场景 2: 细粒度的训练/验证/测试划分
# ----------------------------------------------------------------------------
# [datasets]
# my_data = "/data/my_experiment.h5ad"
#
# [training]
# my_data = "train"
#
# [zeroshot]
# "my_data.celltype_A" = "val"   # celltype_A 全部作为验证集
#
# [fewshot."my_data.celltype_B"]
# val = ["pert1", "pert2"]       # celltype_B 中选择少量扰动验证
# test = ["pert3", "pert4"]      # celltype_B 中选择其他扰动测试
# ----------------------------------------------------------------------------


# 场景 3: 跨数据集泛化测试
# ----------------------------------------------------------------------------
# [datasets]
# source_data = "/data/source.h5ad"      # 源域数据
# target_data = "/data/target.h5ad"      # 目标域数据
#
# [training]
# source_data = "train"                  # 只在源域训练
#
# [zeroshot]
# "target_data.celltype1" = "test"       # 目标域作为零样本测试
# "target_data.celltype2" = "test"
# ----------------------------------------------------------------------------


# ============================================================================
# 故障排除提示
# ============================================================================
#
# 如果遇到配置错误：
#
# 1. TOML 语法错误：
#    - 使用在线 TOML 验证工具检查语法
#    - 确保字符串都用双引号
#    - 确保列表格式正确
#
# 2. 数据集找不到：
#    - 检查路径是否为绝对路径
#    - 使用 `ls` 命令验证通配符展开
#    - 检查文件权限
#
# 3. 细胞类型/扰动名称不匹配：
#    - 在 Python 中检查数据：
#      ```python
#      import anndata as ad
#      adata = ad.read_h5ad('data.h5ad')
#      print(adata.obs['cell_type'].unique())  # 查看细胞类型
#      print(adata.obs['gene'].unique())       # 查看扰动
#      ```
#
# 4. 配置冲突：
#    - 记住优先级：fewshot > zeroshot > training
#    - 检查是否有扰动被多次划分
#
# ============================================================================
