# finetune_v2.py 和 infer_lora_v2.py 使用文档

## 1. finetune_v2.py 脚本功能总结

### 核心功能
该脚本是一个优化版的微调脚本，专门用于药物扰动预测的 pearson_delta 指标优化。主要包含：

1. **LoRA 微调模块**：
   - `LoRALinear` 类：低秩适配层，可替换原始 Linear 层
   - 支持设置 rank 和 alpha 参数控制适配容量
   - 通过 `replace_linear_with_lora()` 函数自动替换目标模块

2. **Delta-Aware 损失函数** (`DeltaAwareLoss` 类)：
   - `delta_mse`：预测 delta 与真实 delta 的 MSE
   - `delta_pearson`：预测 delta 与真实 delta 的 Pearson 相关损失
   - `mse`：原始绝对表达值 MSE
   - 通过 `lambda_delta`, `lambda_pearson`, `lambda_mse` 权重组合

3. **智能数据集** (`AnnDataPerturbationDatasetV2` 类)：
   - 支持按批次(batch)匹配控制组和扰动组细胞
   - 预计算控制组均值用于 delta 计算
   - 自动识别控制组和扰动组

### 命令行参数
```
必需参数:
  --model_dir       模型目录（包含 config.yaml）
  --adata           输入 AnnData 文件 (.h5ad)

可选参数:
  --checkpoint      模型检查点路径 (.ckpt)
  --embed_key       adata.obsm 中的嵌入键
  --pert_col        扰动条件列名 (默认: target_gene)
  --output_lora     输出 LoRA 状态路径 (默认: ./lora_state.pth)
  --epochs          训练轮数 (默认: 3)
  --batch_size      批次大小 (默认: 128)
  --lr              学习率 (默认: 5e-4)
  --weight_decay    权重衰减 (默认: 0.0)
  --lora_rank       LoRA 秩 (默认: 8)
  --lora_alpha      LoRA alpha (默认: 1.0)
  --target_modules  逗号分隔的目标模块关键词
  --save_dir        保存目录 (默认: ./lora_out)

V2 新增参数:
  --batch_col       批次列名（用于智能配对）
  --use_delta_loss  启用 Delta-Aware 损失
  --no_delta_loss   禁用 Delta-Aware 损失
  --lambda_delta    delta MSE 损失权重 (默认: 1.0)
  --lambda_pearson  delta Pearson 损失权重 (默认: 0.5)
  --lambda_mse      绝对 MSE 损失权重 (默认: 0.5)
  --control_label   覆盖控制组标签
```

### 使用示例
```bash
export CUDA_VISIBLE_DEVICES=1

python finetune_v2.py \
  --model_dir /path/to/model_dir \
  --checkpoint /path/to/checkpoint.ckpt \
  --adata /path/to/data.h5ad \
  --pert_col drugname_drugconc \
  --output_lora ./lora_state.pth \
  --save_dir ./lora_out \
  --epochs 5 \
  --batch_size 128 \
  --lr 2e-4 \
  --lora_rank 16 \
  --lora_alpha 32 \
  --use_delta_loss \
  --lambda_delta 1.0 \
  --lambda_pearson 0.5 \
  --lambda_mse 0.5 \
  --weight_decay 1e-4 \
  --target_modules pert_encoder,basal_encoder,transformer_backbone \
  --batch_col plate  # 可选：按批次智能配对
```

---

## 2. infer_lora_v2.py 脚本功能总结

### 核心功能
该脚本是优化版推断脚本，修正了药物扰动预测的推断流程：

1. **关键改进**：使用控制组均值表达作为所有细胞的输入
   - 原始问题：原脚本使用扰动后细胞的表达作为输入
   - 改进后：预测扰动对控制状态细胞的影响

2. **LoRA 权重加载**：
   - 自动检测文件或目录路径
   - 重建 LoRA 层并加载权重
   - 支持从保存的配置推断 rank/alpha

3. **批量推断**：
   - 高效批处理推断
   - 自动填充处理不完整批次
   - 保存元信息到输出文件

### 命令行参数
```
必需参数:
  --adata           输入 AnnData 文件 (.h5ad)
  --model_dir       模型目录

可选参数:
  --checkpoint      模型检查点路径
  --embed_key       adata.obsm 中的嵌入键
  --pert_col        扰动条件列名 (默认: drugname_drugconc)
  --output          输出 AnnData 文件路径
  --celltype_col    细胞类型列名
  --celltypes       逗号分隔的细胞类型列表（筛选用）
  --batch_size      批次大小 (默认: 1000)
  --lora_path       LoRA 权重文件或目录路径

V2 新增参数:
  --use_ctrl_mean   使用控制组均值作为输入 (默认: True)
  --no_ctrl_mean    禁用控制组均值模式
  --control_label   覆盖控制组标签
```

### 使用示例
```bash
export CUDA_VISIBLE_DEVICES=1

python infer_lora_v2.py \
  --model_dir /path/to/model_dir \
  --checkpoint /path/to/checkpoint.ckpt \
  --lora_path /path/to/lora_out/lora_epoch4.pth \
  --adata /path/to/data.h5ad \
  --pert_col drugname_drugconc \
  --output /path/to/output.h5ad \
  --batch_size 1024
```

---

## 完整工作流程

### 步骤 1: 准备数据
确保 h5ad 文件包含：
- 基因表达矩阵 (adata.X)
- 扰动条件列 (adata.obs[pert_col])
- 可选: 批次信息列 (adata.obs[batch_col])

### 步骤 2: LoRA 微调
```bash
python finetune_v2.py \
  --model_dir /path/to/ST-Tahoe \
  --checkpoint /path/to/final.ckpt \
  --adata /path/to/prep.h5ad \
  --pert_col drugname_drugconc \
  --output_lora /path/to/lora_state.pth \
  --save_dir /path/to/lora_out \
  --epochs 5 \
  --use_delta_loss \
  --target_modules pert_encoder,basal_encoder,transformer_backbone
```

### 步骤 3: 推断预测
```bash
python infer_lora_v2.py \
  --model_dir /path/to/ST-Tahoe \
  --checkpoint /path/to/final.ckpt \
  --lora_path /path/to/lora_out/lora_epoch4.pth \
  --adata /path/to/prep.h5ad \
  --pert_col drugname_drugconc \
  --output /path/to/infer.h5ad
```

### 步骤 4: 评估结果
使用 cell-eval 工具评估：
```bash
cell-eval run \
    -ap /path/to/infer.h5ad \
    -ar /path/to/prep.h5ad \
    -o /path/to/results \
    --control-pert "[('DMSO_TF', 0.0, 'uM')]" \
    --pert-col 'drugname_drugconc' \
    --profile minimal
```

---

## 注意事项

1. **控制组标签**：对于药物扰动数据集，默认控制标签是 `"[('DMSO_TF', 0.0, 'uM')]"`

2. **LoRA 目标模块**：推荐使用 `pert_encoder,basal_encoder,transformer_backbone`

3. **损失权重**：建议先使用默认值，根据验证集性能调整

4. **Epoch 选择**：通常选择验证损失最低的 epoch 的 LoRA 权重

5. **V2 改进**：如果 pearson_delta 指标很重要，务必使用 V2 版本的脚本
